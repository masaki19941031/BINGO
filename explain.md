# プログラム説明

本ファイルではビンゴゲーム処理全体の考え方やファイル・クラス構成を説明します。
コード自体の説明はコメントで直接記載していますが、Ruby自体の構文やメソッドについての説明はしていませんのでRubyマニュアルにてご確認お願いします。

## プログラム実行

main.rbがあるディレクトリに移動してからmain.rbを実行してください。

    ruby main.rb

## ファイル構成

* main.rb: メインスクリプトです。このファイルを実行してください。
* requires.rb: main.rbから読み込まれるファイルです。ビンゴゲームに必要なファイル一覧をこの中で読み込みます。
* class
  * bingo.rb: ビンゴゲームを表すモジュールとゲーム設定の定数定義です。
  * game.rb: ビンゴゲームを管理するクラスの定義です。
  * card.rb: ビンゴゲームのカードを表すクラスの定義です。
  * ball.rb: ビンゴゲームのボールを表すクラスの定義です。

## クラス構成

* Bingoモジュール: ビンゴゲームの名前空間を提供するモジュールです。
  * Gameクラス: ビンゴゲームを管理するクラスです。カードオブジェクトとボールオブジェクトを持ちゲームを進行します。
  * Cardクラス: カードを表すクラスです。カード状態を持ち、ビンゴ数やリーチ数を取得します。
  * Ballクラス: ボール(ボール一覧)を表すクラスです。ボール状態を持ち、どの番号を次に引くかを管理します。

## ビンゴゲーム処理の考え方

### カードの表現

ビンゴカードは5x5の合計25マスからなるカードです。
そのためカードを表す2次元配列は5要素の配列の値にさらに5要素の配列をもつ構造になります。

    イメージ
    ※便宜上真ん中のFREEも番号にしています
    ※配列の表現上ビンゴカードを90度回転したような見た目になっている点に注意です

    [
        [ 1, 2, 3, 4, 5], # B列
        [16,17,18,19,20], # I列
        [31,32,33,34,35], # N列
        [46,47,48,49,50], # G列
        [61,62,63,64,65], # O列
    ]

    表示する際は行と列を入れ替えてから表示することで本来のビンゴカードと同じ形にします。

    [  #  B  I  N  G  O
        [ 1,16,31,46,61],
        [ 2,17,32,47,62],
        [ 3,18,33,48,63],
        [ 4,19,34,49,64],
        [ 5,20,35,50,65],
    ]

また、各列割当可能な番号の範囲が決まっており、1を最小としてB列から順に15個ずつの数字が範囲となります。
これは列のインデックスIと各列の番号数M(=15)を使って簡単に数式化することができます。

    I * M + 1 ～ (I + 1) * M
    
    B列(I=0): 0 * 15 + 1 ～ (0 + 1) * 15 => 1 ～ 15
    I列(I=1): 1 * 15 + 1 ～ (1 + 1) * 15 => 16 ～ 30
    N列(I=2): 2 * 15 + 1 ～ (2 + 1) * 15 => 31 ～ 45
    G列(I=3): 3 * 15 + 1 ～ (3 + 1) * 15 => 46 ～ 60
    O列(I=4): 4 * 15 + 1 ～ (4 + 1) * 15 => 61 ～ 75

真ん中のFREEマスについてはいつくか方法がありますが、今回は特殊な番号(-1)を割り当てることで表現しています。

### ボールの表現

ボールはカード番号の範囲から1～75の合計75個になります。
これは カードサイズ5 x 各列の番号数15 = 75 になります。

ボールを重複せずに引いていくために1～75の番号の配列をあらかじめ用意してシャッフルしておきます。
あとは現在どの位置の番号が引いているボールかを指すindexを用意しておくことでボールを引く処理を実現します。

    あらかじめ番号の出る順番を配列で用意
    [8,46,34,9,70,1,11,25,23,...]

    index=0
    [8,46,34,9,70,1,11,25,23,...]
     ↑

    index=1
    [8,46,34,9,70,1,11,25,23,...]
        ↑

    indexをすすめることで次のボールを引いていく        
    
## カードに穴をあける処理

これについてもいくつか方法がありますが、今回は単純に引いた番号をハッシュ(マップ)に格納していきます。
ハッシュに格納するのはカードのマスに穴が空いているか調べるときに高速だからです。

    例) 引いた番号を配列に追加していく場合
    [2,70,6,13]

    カードの13のマスに穴が空いているか調べるには配列の中身を順番に見ていく必要がある
    [2,70,6,13]
     ↑
    [2,70,6,13]
        ↑
    [2,70,6,13]
          ↑
    [2,70,6,13]
             ↑
 
    例) 引いた番号をハッシュに追加していく場合
    {2 => true, 70 => true, 6 => true, 13 => true}

    カードの13のマスに穴が空いているか調べるのはキーがあるか確認するだけ

## ビンゴの判定

ビンゴになる条件は以下の3パターンしかありません
1. どこかの列にすべて穴がある
1. どこかの行にすべて穴がある
1. どちらかの斜めにすべて穴がある

よって、各列のライン、各行のライン、右下斜めのライン、右上斜めのラインのそれぞれについて穴が何個空いているかを調べれば良いです。
具体的には上記それぞれのカウント変数を用意しておいてカードのすべてのマスを調べて穴があいていたら対応する変数をカウントします。

    イメージ
    ※○が穴が空いているマス、×が穴が空いていないマス、Fは真ん中

    [初期状態]
                          B I N G O列目のカウント
                          ↓ ↓ ↓ ↓ ↓
                          0 0 0 0 0 
     右下斜めのカウント→ 0|----------0 ←右上斜めのカウント
        1行目のカウント→ 0|○ ○ × × ○
        2行目のカウント→ 0|○ ○ × × ○
        3行目のカウント→ 0|× × F ○ ○
        4行目のカウント→ 0|× ○ ○ ○ ○
        5行目のカウント→ 0|○ × × × ○
    
    各マスを順番に調べていく
    [B-1マス]
    穴が空いているのでB列目、1行目、右下斜めのカウントを加算
      1 0 0 0 0 
    1|----------0
    1|○ ○ × × ○
    0|○ ○ × × ○
    0|× × F ○ ○
    0|× ○ ○ ○ ○
    0|○ × × × ○

    [B-2マス]
    穴が空いているのでB列目、2行目のカウントを加算
      2 0 0 0 0 
    1|----------0
    1|○ ○ × × ○
    1|○ ○ × × ○
    0|× × F ○ ○
    0|× ○ ○ ○ ○
    0|○ × × × ○

    [B-3マス]
    穴が空いていないので何もしない
      2 0 0 0 0 
    1|----------0
    1|○ ○ × × ○
    1|○ ○ × × ○
    0|× × F ○ ○
    0|× ○ ○ ○ ○
    0|○ × × × ○

    [B-4マス]
    穴が空いていないので何もしない
      2 0 0 0 0 
    1|----------0
    1|○ ○ × × ○
    1|○ ○ × × ○
    0|× × F ○ ○
    0|× ○ ○ ○ ○
    0|○ × × × ○

    [B-5マス]
    穴が空いていなるのでB列目、5列目、右上斜めのカウントを加算
      3 0 0 0 0 
    1|----------1
    1|○ ○ × × ○
    1|○ ○ × × ○
    0|× × F ○ ○
    0|× ○ ○ ○ ○
    1|○ × × × ○

    I-1以降も同様にしていく
    ※FREEマスは無条件に穴が空いているものとして扱うか、あらかじめ引いた番号のハッシュにFREEを追加しておけば良い

    [最終結果]
      3 3 2 2 5 
    5|----------4
    3|○ ○ × × ○
    3|○ ○ × × ○
    3|× × F ○ ○
    4|× ○ ○ ○ ○
    2|○ × × × ○

    あとはカウントが5であるラインを数えればビンゴの数がわかる(上記の場合2ビンゴ)。
    同様に、カウントが4であるラインを数えればリーチの数もわかる(上記の場合2リーチ)

### 斜めのカウント判定について

列や行のカウントは各マスごとに対応する列・行のカウントを加算すればよいですが、斜めについては特定のマスでしかカウントを加算しません。

    調べているマスの列をrow、行をlineとします。
    また、rowとlineは0～4の値を取ります。(配列の添字は0始まり)

    [右下斜めの場合]
    row == line のマスの穴が空いている場合にカウント

    以下の該当するマスのrow、lineを見ると明らかです。
              row
           0 1 2 3 4 
          |----------
         0|○
         1|  ○
    line 2|    ○
         3|      ○
         4|        ○

    [右上斜めの場合]
    カードサイズをC(=5)とした場合
    row + line == c - 1 のマスの穴が空いている場合にカウント

    これも以下の該当するマスのrow、lineを見ると明らかです。
              row
           0 1 2 3 4 
          |----------
         0|        ○
         1|      ○
    line 2|    ○
         3|  ○
         4|○

## ビンゴゲームの流れ

ビンゴゲームの流れは以下になります。

1. ボールを引く
2. カードのマスに引いた番号のマスがあれば穴をあける
   ※今回は簡単のため無条件にハッシュに追加しています
   (穴があるか確認するほうが処理が複雑になるのと、ビンゴ判定の際に穴があいているかチェックしています)
3. もうボールがないか、カードのマス全てに穴が空いていたら終了